---
title: "RNAseq"
author: "LIPINSKI Boris"
date: '2025-02'
output:
  rmdformats::readthedown:
  code_folding: hide
params:
  protocol:
    value: "SE"
    choices: ["SE", "PE"]
  metadata.file: 
    value: "file.csv"
    input: text 
  result.dir: 
    value: "dir"
    input: text 
  output: 
    value: "dir"
    input: text 
  script.dir: 
    value: "dir"
    input: text 
fig.width: 8
fig.height: 12
toc_depth: 3
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jsonlite)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(DESeq2)
library(tximportData)
library(tximport)
library(readr)
library(pheatmap)
library(RColorBrewer)


protocol_value <- params$protocol
metadata.file <- params$metadata.file
result.dir <- params$result.dir
script.dir <- params$script.dir

source(file = paste0(script.dir,"/bin/fonction.r"))

```


# Quality check from Kallisto output {.tabset}

This information is coupled with the multiQC report generated by the pipeline


```{r, echo=F, warning=F, error=F, message=F}
logs.path <- result.dir
logs.files <- list.files(logs.path, pattern = paste0("_",protocol_value,"_run_info.json$"), full.names = TRUE)
logs.result <- data.frame()

cols <- c("n_targets", "n_processed", "n_pseudoaligned", "n_unique", "p_pseudoaligned", "p_unique")

for (log in logs.files) {
  log.json <- t(as.data.frame(jsonlite::fromJSON(log)))
  log.json <- as.data.frame(log.json[cols, ])
  colnames(log.json) <- gsub("_run_info.json", "", basename(log))
  if (nrow(logs.result) == 0) {
    logs.result <- log.json
  } else {
    logs.result <- cbind(logs.result, log.json)
  }
}

logs.result <- as.data.frame(t(logs.result))
logs.result$Sample <- rownames(logs.result)
logs.result$Condition <- "Traited"
logs.result[grep("Untreated", logs.result$Sample, ignore.case = TRUE), "Condition" ] <- "Untreated"
logs.result$Protocol <- "PE"
logs.result[grep("SE", logs.result$Sample, ignore.case = TRUE), "Protocol" ] <- "SE"

logs.pivot <- logs.result %>% pivot_longer(cols = -c(Sample,Condition,Protocol), names_to = "Feature", values_to = "Value")
logs.pivot$Value <- as.numeric(logs.pivot$Value)

```

## Protocol {.tabset}
```{r, results='asis', echo=F, warning=F, error=F, message=F}
for (col in cols) {
  cat("### ", col, "\n\n")
  
  logs.subset <- logs.pivot %>% filter(Feature == col)
  print(ggplot(logs.subset) +
          aes(x = Protocol, y = Value) + 
          geom_boxplot() +
          scale_fill_hue(direction = 1) +
          theme_minimal() +
          facet_wrap(vars(Feature), scales = "free"))
  
  cat("\n\n")
}
```

## Protocol + Condition {.tabset}
```{r, results='asis', echo=F, warning=F, error=F, message=F}
for (col in cols) {
  cat("### ", col, "\n\n")
  
  logs.subset <- logs.pivot %>% filter(Feature == col)
  moyennes <- logs.subset %>% group_by(Protocol) %>% summarise(moyenne = mean(Value, na.rm = TRUE))
  print(ggplot(logs.subset) + aes(x = Protocol, y = Value, fill = Condition) +
          geom_boxplot() +
          #geom_hline(data = moyennes, aes(yintercept = moyenne, color = Protocol), linetype = "dashed", size = 1) +
          scale_fill_hue(direction = 1) +
          theme_minimal() +
          facet_wrap(vars(Feature), scales = "free") +
          labs(color = "Moyenne par protocole"))
  
  cat("\n\n")
}
```


# Differental Expression : Treated vs Untreated
```{r, echo=F, warning=F, error=F, message=F}
counts.path <- result.dir
counts.files <- list.files(counts.path, pattern = paste0("_",protocol_value,"_abundance.tsv"), full.names = TRUE)
counts.result <- data.frame()
#names(counts.files) <- c(
#  "Treated1_PE", "Treated1_SE", "Treated2_PE", "Treated2_SE", "Treated3_PE", "Treated3_SE", "Treated4_PE", "Treated4_SE", 
#  "Untreated1_PE", "Untreated1_SE", "Untreated2_PE", "Untreated2_SE", "Untreated3_PE", "Untreated3_SE", "Untreated4_PE", "Untreated4_SE"
#)
```

```{r, echo=F, warning=F, error=F, message=F}
tx2gene <- read_csv(paste0(script.dir,"/dependencies/tx2gene.gencode.v27.csv"))
count.txi <- tximport(counts.files, type = "kallisto", tx2gene = tx2gene, ignoreAfterBar = TRUE)

#metadata <- data.frame(
#  sample = c(
#    "Treated1_PE", "Treated1_SE", "Treated2_PE", "Treated2_SE", "Treated3_PE", "Treated3_SE", "Treated4_PE", "Treated4_SE",
#    "Untreated1_PE", "Untreated1_SE", "Untreated2_PE", "Untreated2_SE", "Untreated3_PE", "Untreated3_SE", "Untreated4_PE", "Untreated4_SE"
#  ),
#  condition = factor(c(rep("Treated",8),rep("Untreated",8) )),
#  protocol = factor(rep(c("PE", "SE"), 8))
#)
#rownames(metadata) <- colnames(count.txi$counts)

metadata <- read_csv(file = metadata.file)
names(counts.files) <- metadata$sample

colnames(count.txi$counts) <- metadata$sample
write_csv(as.data.frame(count.txi$counts), paste0(result.dir,"/../",protocol_value,"_count.csv"))
```



## Analyse {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
dds <- DESeq_process(metadata=metadata, counts.files=counts.files, Protocol_lvl=protocol_value, formule="condition")
res <- DESeq_result(dds)
```

Result :

- DEGs number : `r nrow(res[res$padj < 0.05,])` (padj < 0.05)
- Up-regulated in Treated condition : `r nrow(res[res$Expression =='Up',])`
- Down-regulated in Treated condition : `r nrow(res[res$Expression =='Down',])`
- Positive logFC = up-regulated in Treated condition / down-regulated in Untreated condition
- Negative logFC = up-regulated in Untreated condition / down-regulated in Treated condition

### Dataset {.tabset}
#### Liste {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
dds <- DESeq_process(metadata=metadata, counts.files=counts.files, Protocol_lvl=protocol_value, formule="condition")
res <- DESeq_result(dds)
DT.table(as.data.frame(res[res$padj < 0.05,c("baseMean","log2FoldChange","pvalue","padj","Expression")]), filename="matrice_count")
```

#### Outlier {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
Oulier_norm(dds)
```

#### Heatmap {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
SampleHeatmap(dds)
```

#### PCA {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
PCA_plot(dds)
```


### Expression {.tabset}
#### Volcano {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
Volcano_plot(res)
```

#### Top20 {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
Top20(res, dds)
```

#### TopHeatmap {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
TopHeatmap(dds, res, FDR=0.01, FC=1.5)
```

#### MDplot {.tabset}
```{r, echo=F, warning=F, error=F, message=F}
MD_plot_DESeq2(dds)
```





